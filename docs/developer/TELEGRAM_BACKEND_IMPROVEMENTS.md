# üîß Plan Ulepsze≈Ñ Backend - Integracja Telegram

## üéØ Cel
Rozszerzenie funkcjonalno≈õci backend dla lepszej integracji z Telegram Bot, dodanie nowych endpoint√≥w i ulepszenie istniejƒÖcych.

## üìã Funkcjonalno≈õci do Dodania

### 1. Nowe Endpointy API
```python
# src/backend/api/v2/endpoints/telegram.py

@router.get("/stats")
async def get_telegram_stats() -> JSONResponse:
    """Pobiera statystyki Telegram Bot"""

@router.get("/logs")
async def get_telegram_logs(limit: int = 100) -> JSONResponse:
    """Pobiera logi Telegram Bot"""

@router.post("/send-notification")
async def send_notification(message: str, chat_id: int | None = None) -> JSONResponse:
    """Wysy≈Ça powiadomienie do u≈ºytkownik√≥w"""

@router.get("/users")
async def get_telegram_users() -> JSONResponse:
    """Pobiera listƒô u≈ºytkownik√≥w bota"""

@router.post("/broadcast")
async def broadcast_message(message: str) -> JSONResponse:
    """Wysy≈Ça wiadomo≈õƒá do wszystkich u≈ºytkownik√≥w"""
```

### 2. Obs≈Çuga Komend
```python
# src/backend/integrations/telegram_commands.py
class TelegramCommandHandler:
    """Handler dla komend Telegram"""
    
    async def handle_start(self, chat_id: int, user_id: int) -> str:
        """Obs≈Çuga komendy /start"""
        
    async def handle_help(self, chat_id: int) -> str:
        """Obs≈Çuga komendy /help"""
        
    async def handle_receipt(self, chat_id: int) -> str:
        """Obs≈Çuga komendy /receipt"""
        
    async def handle_pantry(self, chat_id: int) -> str:
        """Obs≈Çuga komendy /pantry"""
        
    async def handle_recipe(self, chat_id: int, query: str) -> str:
        """Obs≈Çuga komendy /recipe"""
```

### 3. Obs≈Çuga Plik√≥w
```python
# src/backend/integrations/telegram_file_handler.py
class TelegramFileHandler:
    """Handler dla plik√≥w z Telegram"""
    
    async def handle_photo(self, file_id: str, chat_id: int) -> str:
        """Obs≈Çuga zdjƒôƒá (paragony)"""
        
    async def handle_document(self, file_id: str, chat_id: int) -> str:
        """Obs≈Çuga dokument√≥w"""
        
    async def handle_voice(self, file_id: str, chat_id: int) -> str:
        """Obs≈Çuga wiadomo≈õci g≈Çosowych"""
```

---

## üîß Implementacja

### 1. Rozszerzenie TelegramBotHandler
```python
# src/backend/integrations/telegram_bot.py

class TelegramBotHandler:
    def __init__(self):
        self.command_handler = TelegramCommandHandler()
        self.file_handler = TelegramFileHandler()
        self.stats = TelegramStats()
        
    async def handle_command(self, command: str, chat_id: int, user_id: int, args: str = "") -> str:
        """Obs≈Çuguje komendy Telegram"""
        if command == "/start":
            return await self.command_handler.handle_start(chat_id, user_id)
        elif command == "/help":
            return await self.command_handler.handle_help(chat_id)
        elif command == "/receipt":
            return await self.command_handler.handle_receipt(chat_id)
        elif command == "/pantry":
            return await self.command_handler.handle_pantry(chat_id)
        elif command == "/recipe":
            return await self.command_handler.handle_recipe(chat_id, args)
        else:
            return "‚ùå Nieznana komenda. U≈ºyj /help aby zobaczyƒá dostƒôpne komendy."
    
    async def handle_file(self, file_data: dict, chat_id: int) -> str:
        """Obs≈Çuguje pliki z Telegram"""
        file_type = file_data.get("type")
        file_id = file_data.get("file_id")
        
        if file_type == "photo":
            return await self.file_handler.handle_photo(file_id, chat_id)
        elif file_type == "document":
            return await self.file_handler.handle_document(file_id, chat_id)
        elif file_type == "voice":
            return await self.file_handler.handle_voice(file_id, chat_id)
        else:
            return "‚ùå Nieobs≈Çugiwany typ pliku."
```

### 2. System Statystyk
```python
# src/backend/integrations/telegram_stats.py
class TelegramStats:
    """System statystyk dla Telegram Bot"""
    
    def __init__(self):
        self.message_count = 0
        self.response_times = []
        self.error_count = 0
        self.user_count = 0
        
    async def record_message(self, user_id: int, response_time: float):
        """Zapisuje statystyki wiadomo≈õci"""
        self.message_count += 1
        self.response_times.append(response_time)
        
    async def record_error(self, error_type: str):
        """Zapisuje b≈Çƒôdy"""
        self.error_count += 1
        
    async def get_stats(self) -> dict:
        """Pobiera statystyki"""
        avg_response_time = sum(self.response_times) / len(self.response_times) if self.response_times else 0
        
        return {
            "total_messages": self.message_count,
            "average_response_time": round(avg_response_time, 2),
            "error_count": self.error_count,
            "unique_users": self.user_count,
            "uptime": self.get_uptime()
        }
```

### 3. System Logowania
```python
# src/backend/integrations/telegram_logger.py
class TelegramLogger:
    """System logowania dla Telegram Bot"""
    
    def __init__(self):
        self.log_file = "logs/telegram_bot.log"
        
    async def log_message(self, user_id: int, message: str, response: str, response_time: float):
        """Loguje wiadomo≈õƒá u≈ºytkownika"""
        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "user_id": user_id,
            "message": message,
            "response": response,
            "response_time": response_time,
            "type": "message"
        }
        
        await self._write_log(log_entry)
        
    async def log_error(self, error: str, user_id: int | None = None):
        """Loguje b≈Çƒôdy"""
        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "user_id": user_id,
            "error": error,
            "type": "error"
        }
        
        await self._write_log(log_entry)
```

---

## üéØ Nowe Funkcjonalno≈õci

### 1. Komendy Bot
```python
# Komendy do zaimplementowania
COMMANDS = {
    "/start": "Rozpocznij rozmowƒô z asystentem",
    "/help": "Poka≈º dostƒôpne komendy",
    "/receipt": "Prze≈õlij paragon do analizy",
    "/pantry": "Sprawd≈∫ stan spi≈ºarni",
    "/recipe": "Znajd≈∫ przepis",
    "/weather": "Sprawd≈∫ pogodƒô",
    "/search": "Wyszukaj informacje",
    "/settings": "Ustawienia u≈ºytkownika"
}
```

### 2. Obs≈Çuga Plik√≥w
```python
# Obs≈Çugiwane typy plik√≥w
SUPPORTED_FILES = {
    "photo": "Zdjƒôcia paragon√≥w",
    "document": "Dokumenty PDF",
    "voice": "Wiadomo≈õci g≈Çosowe"
}
```

### 3. Powiadomienia
```python
# System powiadomie≈Ñ
class TelegramNotificationService:
    """Serwis powiadomie≈Ñ Telegram"""
    
    async def send_notification(self, message: str, chat_id: int | None = None):
        """Wysy≈Ça powiadomienie"""
        
    async def send_broadcast(self, message: str):
        """Wysy≈Ça wiadomo≈õƒá do wszystkich u≈ºytkownik√≥w"""
        
    async def send_alert(self, alert_type: str, data: dict):
        """Wysy≈Ça alert systemowy"""
```

---

## üîí Bezpiecze≈Ñstwo

### 1. Walidacja U≈ºytkownik√≥w
```python
class TelegramUserValidator:
    """Walidacja u≈ºytkownik√≥w Telegram"""
    
    def __init__(self):
        self.allowed_users = set()  # Lista dozwolonych u≈ºytkownik√≥w
        self.blocked_users = set()  # Lista zablokowanych u≈ºytkownik√≥w
        
    async def validate_user(self, user_id: int) -> bool:
        """Sprawdza czy u≈ºytkownik ma dostƒôp"""
        if user_id in self.blocked_users:
            return False
        if self.allowed_users and user_id not in self.allowed_users:
            return False
        return True
```

### 2. Rate Limiting
```python
class TelegramRateLimiter:
    """Rate limiting dla Telegram"""
    
    def __init__(self):
        self.user_limits = {}  # Limit per user
        self.global_limit = 100  # Globalny limit
        
    async def check_rate_limit(self, user_id: int) -> bool:
        """Sprawdza rate limit dla u≈ºytkownika"""
        current_time = time.time()
        
        if user_id not in self.user_limits:
            self.user_limits[user_id] = []
            
        # Usu≈Ñ stare wpisy (starsze ni≈º 1 minuta)
        self.user_limits[user_id] = [
            t for t in self.user_limits[user_id] 
            if current_time - t < 60
        ]
        
        # Sprawd≈∫ limit
        if len(self.user_limits[user_id]) >= 30:  # 30 wiadomo≈õci na minutƒô
            return False
            
        self.user_limits[user_id].append(current_time)
        return True
```

### 3. Szyfrowanie Danych
```python
class TelegramDataEncryption:
    """Szyfrowanie danych Telegram"""
    
    def __init__(self):
        self.encryption_key = settings.TELEGRAM_ENCRYPTION_KEY
        
    async def encrypt_token(self, token: str) -> str:
        """Szyfruje token bota"""
        
    async def decrypt_token(self, encrypted_token: str) -> str:
        """Deszyfruje token bota"""
        
    async def encrypt_user_data(self, user_data: dict) -> str:
        """Szyfruje dane u≈ºytkownika"""
```

---

## üìä Monitoring i Metryki

### 1. Prometheus Metrics
```python
# src/backend/monitoring/telegram_metrics.py
from prometheus_client import Counter, Histogram, Gauge

# Metryki Telegram
telegram_messages_total = Counter('telegram_messages_total', 'Total Telegram messages')
telegram_response_time = Histogram('telegram_response_time_seconds', 'Telegram response time')
telegram_errors_total = Counter('telegram_errors_total', 'Total Telegram errors')
telegram_active_users = Gauge('telegram_active_users', 'Active Telegram users')
```

### 2. Grafana Dashboard
```json
// monitoring/grafana/dashboards/telegram-dashboard.json
{
  "dashboard": {
    "title": "Telegram Bot Metrics",
    "panels": [
      {
        "title": "Messages per Hour",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(telegram_messages_total[1h])"
          }
        ]
      },
      {
        "title": "Average Response Time",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(telegram_response_time_seconds_sum[5m]) / rate(telegram_response_time_seconds_count[5m])"
          }
        ]
      },
      {
        "title": "Active Users",
        "type": "stat",
        "targets": [
          {
            "expr": "telegram_active_users"
          }
        ]
      }
    ]
  }
}
```

---

## üß™ Testy

### 1. Unit Tests
```python
# tests/unit/test_telegram_bot.py
class TestTelegramBotHandler:
    """Testy dla TelegramBotHandler"""
    
    async def test_handle_command_start(self):
        """Test obs≈Çugi komendy /start"""
        
    async def test_handle_command_help(self):
        """Test obs≈Çugi komendy /help"""
        
    async def test_handle_file_photo(self):
        """Test obs≈Çugi zdjƒôƒá"""
        
    async def test_rate_limiting(self):
        """Test rate limiting"""
        
    async def test_user_validation(self):
        """Test walidacji u≈ºytkownik√≥w"""
```

### 2. Integration Tests
```python
# tests/integration/test_telegram_integration.py
class TestTelegramIntegration:
    """Testy integracji Telegram"""
    
    async def test_webhook_processing(self):
        """Test przetwarzania webhook"""
        
    async def test_ai_integration(self):
        """Test integracji z AI"""
        
    async def test_file_upload(self):
        """Test uploadu plik√≥w"""
        
    async def test_notifications(self):
        """Test powiadomie≈Ñ"""
```

---

## üöÄ Plan Implementacji

### Faza 1: Podstawowe Ulepszenia (2-3 dni)
1. ‚úÖ Rozszerzenie TelegramBotHandler
2. ‚úÖ System komend
3. ‚úÖ Obs≈Çuga plik√≥w
4. ‚úÖ Rate limiting i walidacja

### Faza 2: Zaawansowane Funkcje (3-4 dni)
1. ‚úÖ System statystyk
2. ‚úÖ System logowania
3. ‚úÖ Powiadomienia
4. ‚úÖ Monitoring i metryki

### Faza 3: Bezpiecze≈Ñstwo i Testy (2-3 dni)
1. ‚úÖ Szyfrowanie danych
2. ‚úÖ Walidacja u≈ºytkownik√≥w
3. ‚úÖ Testy jednostkowe i integracyjne
4. ‚úÖ Dokumentacja

---

## üìö Dokumentacja

### 1. API Documentation
- Kompletna dokumentacja endpoint√≥w
- Przyk≈Çady u≈ºycia
- Kody b≈Çƒôd√≥w

### 2. Deployment Guide
- Konfiguracja ≈õrodowiska
- SSL requirements
- Monitoring setup

### 3. User Guide
- Instrukcje konfiguracji
- RozwiƒÖzywanie problem√≥w
- FAQ

---

## üéØ Podsumowanie

Po implementacji ulepsze≈Ñ backend bƒôdzie oferowa≈Ç:

1. **Kompletne API** - Wszystkie potrzebne endpointy
2. **Obs≈Çuga komend** - System komend Telegram
3. **Obs≈Çuga plik√≥w** - Zdjƒôcia, dokumenty, g≈Ços
4. **Bezpiecze≈Ñstwo** - Rate limiting, walidacja, szyfrowanie
5. **Monitoring** - Metryki, logi, alerty
6. **Powiadomienia** - System powiadomie≈Ñ
7. **Testy** - Kompletne pokrycie testami

**Rezultat**: Pe≈Çnoprawny, bezpieczny i skalowalny system Telegram Bot z zaawansowanymi funkcjonalno≈õciami. 